MyEXT60804=typeof MyEXT60804!=="undefined"?MyEXT60804:{};MyEXT60804.__files_present__=MyEXT60804.__files_present__?MyEXT60804.__files_present__+"x":"x";MyEXT60804.Message=function(scope){var _self=scope;var _this=this;var _tabsListenCallbacks={};var listener_id_counter=0;var _consts=MyEXT60804.Consts;var prefManager=Components.classes["@mozilla.org/preferences-service;1"].getService(Components.interfaces.nsIPrefBranch);var callTabCallbacks=function(tabId,msg){if(_tabsListenCallbacks.hasOwnProperty(tabId)){for(var messageListener in _tabsListenCallbacks[tabId]){if(_tabsListenCallbacks[tabId].hasOwnProperty(messageListener)){var tmpMsg=JSON.parse(JSON.stringify(msg));_tabsListenCallbacks[tabId][messageListener].callback(tmpMsg);}}}};var getTabIdFromDocument=function(tabId){if(tabId instanceof HTMLDocument){var doc=tabId;if(doc.defaultView.top==doc.defaultView){tabId=_self.getTabID(doc);}else{tabId=_self.getTabID(doc,doc.location.href,true);}}return tabId;};var _broadcastToTabs=function(msg,to_iframes,conditionOnTabId){if(typeof(to_iframes)!=="boolean"){to_iframes=true;}for(var currentTabID in _tabsListenCallbacks){try{if(_tabsListenCallbacks.hasOwnProperty(currentTabID)){if(typeof conditionOnTabId==="function"&&!conditionOnTabId(currentTabID)){continue;}if(!to_iframes&&currentTabID.indexOf("&iframeid=")>=0){continue;}var tmpMsg=JSON.parse(JSON.stringify(msg));callTabCallbacks(currentTabID,tmpMsg);}}catch(e){}}};var listenOrigin=function(callbackFunction,tabId){var is_tab_id_document=(tabId instanceof HTMLDocument);tabId=getTabIdFromDocument(tabId);if(!_tabsListenCallbacks.hasOwnProperty(tabId)){_tabsListenCallbacks[tabId]={};}++listener_id_counter;_tabsListenCallbacks[tabId][listener_id_counter]={callback:callbackFunction};if(is_tab_id_document){return tabId;}else{return listener_id_counter;}};var removeListenerOrigin=function(listenerId,currentTabId){listenerId=getTabIdFromDocument(listenerId);if(typeof(listenerId)==="string"&&(listenerId.indexOf("panel")>=0)&&_tabsListenCallbacks.hasOwnProperty(listenerId)){delete _tabsListenCallbacks[listenerId];return true;}if(typeof(listenerId)==="undefined"&&_tabsListenCallbacks.hasOwnProperty(currentTabId)){delete _tabsListenCallbacks[currentTabId];return true;}if(typeof(listenerId)!=="number"){return false;}if(_tabsListenCallbacks.hasOwnProperty(currentTabId)){if(_tabsListenCallbacks[currentTabId].hasOwnProperty(listenerId)){delete _tabsListenCallbacks[currentTabId][listenerId];return true;}}return false;};var toActiveTab=function(msg,to_iframes){if(typeof(to_iframes)!=="boolean"){to_iframes=true;}var tabId=gBrowser.selectedTab.linkedPanel,selectedTabDocument=gBrowser.contentDocument;if(_tabsListenCallbacks[tabId]){callTabCallbacks(tabId,msg);}if(to_iframes){toCurrentTabIframes(msg,selectedTabDocument);}};var toCurrentTabWindow=function(msg,doc){var topDocument=doc.defaultView.top.document,topTabId=_self.getTabID(topDocument);if(_tabsListenCallbacks[topTabId]){callTabCallbacks(topTabId,msg);}};var toCurrentTabIframes=function(msg,doc){var runInIframe=false;if(prefManager.prefHasUserValue(_consts.CROSSRIDER_BRANCH+"."+_self.appID+".iframe")){runInIframe=prefManager.getBoolPref(_consts.CROSSRIDER_BRANCH+"."+_self.appID+".iframe");}if(!runInIframe){return;}var topDocument=doc.defaultView.top.document,topTabID=_self.getTabID(topDocument),tabsFilter=topTabID+"&iframeid=";for(var pageID in _tabsListenCallbacks){if(_tabsListenCallbacks.hasOwnProperty(pageID)&&(pageID.indexOf(tabsFilter)>=0)){var tmpMsg=JSON.parse(JSON.stringify(msg));callTabCallbacks(pageID,tmpMsg);}}};var toAllTabs=function(msg,to_iframes){_broadcastToTabs(msg,to_iframes);};var toAllOtherTabs=function(msg,to_iframes){var activeTabId=gBrowser.selectedTab.linkedPanel;_broadcastToTabs(msg,to_iframes,function(currentTabID){return !(typeof currentTabID==="string"&&currentTabID.indexOf(activeTabId)===0);});};var toBackground=function(msg){var msgWin=_self.background.getMessagingIframe();if(msgWin){msgWin.newMessage(msg);}};var toPopup=function(msg){var msgWin;if(_self.background.isPageActionPopupOpen()){msgWin=_self.background.getPopupBrowser("pageAction");}if(_self.background.isBrowserActionPopupOpen()){msgWin=_self.background.getPopupBrowser("browserAction");}if(msgWin){msgWin.eval('window["'+_consts.BROWSER_ACTION_POPUP_MESSAGE_STORE+'"] = '+msg+';var evt = document.createEvent("Events");evt.initEvent("'+_consts.BROWSER_ACTION_POPUP_MESSAGE_EVENT_NAME+'", true, false);document.dispatchEvent(evt);');}};(function ctor(){gBrowser.tabContainer.addEventListener("TabClose",function(aEvent){if(aEvent&&aEvent.target&&aEvent.target.linkedPanel){if(_tabsListenCallbacks[aEvent.target.linkedPanel]){delete _tabsListenCallbacks[aEvent.target.linkedPanel];}}},false);}());return{listenOrigin:listenOrigin,removeListenerOrigin:removeListenerOrigin,toActiveTab:toActiveTab,toCurrentTabWindow:toCurrentTabWindow,toCurrentTabIframes:toCurrentTabIframes,toAllTabs:toAllTabs,toAllOtherTabs:toAllOtherTabs,toBackground:toBackground,toPopup:toPopup,__exposedProps__:{listenOrigin:"wr",removeListenerOrigin:"wr",toActiveTab:"wr",toCurrentTabWindow:"wr",toCurrentTabIframes:"wr",toAllTabs:"wr",toAllOtherTabs:"wr",toBackground:"wr",toPopup:"wr"}};};
